name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-and-analyze:
    name: Test y AnÃ¡lisis EstÃ¡tico
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: admin
          MYSQL_DATABASE: sistema_eventos_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: 1ï¸âƒ£ Instalar dependencias
        run: |
          echo "ðŸ“¦ Instalando dependencias..."
          npm ci

      - name: Configurar variables de entorno
        run: |
          echo "NODE_ENV=test" >> $GITHUB_ENV
          echo "DB_HOST=localhost" >> $GITHUB_ENV
          echo "DB_PORT=3306" >> $GITHUB_ENV
          echo "DB_USER=root" >> $GITHUB_ENV
          echo "DB_PASSWORD=admin" >> $GITHUB_ENV
          echo "DB_NAME=sistema_eventos_test" >> $GITHUB_ENV

      - name: 2ï¸âƒ£ Ejecutar pruebas unitarias
        run: |
          echo "ðŸ§ª Ejecutando pruebas unitarias..."
          npm test -- tests/asistenciaService.test.js tests/cache.test.js

      - name: 3ï¸âƒ£ Ejecutar pruebas de integraciÃ³n
        run: |
          echo "ðŸ”— Ejecutando pruebas de integraciÃ³n..."
          npm test -- tests/asistencias.integration.test.js

      - name: 4ï¸âƒ£ Ejecutar anÃ¡lisis estÃ¡tico de seguridad
        run: |
          echo "ðŸ”’ Ejecutando anÃ¡lisis estÃ¡tico..."
          npm run lint

      - name: 5ï¸âƒ£ Ejecutar pruebas de sistema
        run: |
          echo "ðŸ–¥ï¸ Ejecutando pruebas de sistema..."
          npm test -- tests/sistema.test.js

      - name: âœ… Pipeline completado exitosamente
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                        â•‘"
          echo "â•‘              âœ… OK âœ…                  â•‘"
          echo "â•‘                                        â•‘"
          echo "â•‘   Todas las pruebas pasaron           â•‘"
          echo "â•‘   correctamente                        â•‘"
          echo "â•‘                                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸ“Š Resumen de resultados
        if: always()
        run: |
          echo "### Resumen de Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Paso | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| InstalaciÃ³n de dependencias | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Pruebas unitarias | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Pruebas de integraciÃ³n | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| AnÃ¡lisis estÃ¡tico | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Pruebas de sistema | âœ… |" >> $GITHUB_STEP_SUMMARY
